name: Update Homebrew Tap

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag (e.g., v0.1.0)"
        required: true

permissions:
  contents: read

jobs:
  update-tap:
    runs-on: ubuntu-latest

    steps:
      - name: Resolve release tag
        id: release
        run: |
          if [ -n "${{ inputs.tag }}" ]; then
            tag="${{ inputs.tag }}"
          else
            tag="${{ github.event.release.tag_name }}"
          fi
          if [ -z "$tag" ]; then
            echo "Release tag is required." >&2
            exit 1
          fi
          echo "tag=$tag" >> "$GITHUB_OUTPUT"
          echo "version=${tag#v}" >> "$GITHUB_OUTPUT"

      - name: Download tarball and compute checksum
        id: tarball
        run: |
          curl -L \
            "https://github.com/${{ github.repository }}/archive/refs/tags/${{ steps.release.outputs.tag }}.tar.gz" \
            -o clawtunes.tar.gz
          echo "sha256=$(shasum -a 256 clawtunes.tar.gz | awk '{print $1}')" >> "$GITHUB_OUTPUT"

      - name: Checkout homebrew tap
        uses: actions/checkout@v4
        with:
          repository: forketyfork/homebrew-tap
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          path: homebrew-tap

      - name: Update formula
        env:
          VERSION: ${{ steps.release.outputs.version }}
          SHA256: ${{ steps.tarball.outputs.sha256 }}
        run: |
          python - <<'PY'
          from pathlib import Path
          import re
          import os

          formula_path = Path("homebrew-tap/Formula/clawtunes.rb")
          content = formula_path.read_text(encoding="utf-8")
          version = os.environ["VERSION"]
          sha256 = os.environ["SHA256"]

          url = f"https://github.com/forketyfork/clawtunes/archive/refs/tags/v{version}.tar.gz"
          content, url_changes = re.subn(
              r'^(\s*url\b\s+)\\?"[^"]+\\?"',
              rf'\1"{url}"',
              content,
              flags=re.MULTILINE,
          )
          content, sha_changes = re.subn(
              r'^(\s*sha256\b\s+)\\?"[^"]+\\?"',
              rf'\1"{sha256}"',
              content,
              count=1,
              flags=re.MULTILINE,
          )
          content, version_changes = re.subn(
              r'^(\s*version\b\s+)\\?"[^"]+\\?"',
              rf'\1"{version}"',
              content,
              count=1,
              flags=re.MULTILINE,
          )

          if url_changes == 0 or sha_changes == 0:
              raise SystemExit(
                  f"Failed to update formula (url_changes={url_changes}, sha_changes={sha_changes})"
              )

          if version_changes == 0 and 'version "' in content:
              raise SystemExit("Failed to update formula version stanza.")

          if f'v{version}.tar.gz' not in content:
              raise SystemExit("Updated formula does not reference the release tag.")

          formula_path.write_text(content, encoding="utf-8")
          PY

      - name: Commit and push
        env:
          VERSION: ${{ steps.release.outputs.version }}
        run: |
          cd homebrew-tap
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          if [ -n "$(git status --porcelain)" ]; then
            git add Formula/clawtunes.rb
            git commit -m "chore: update clawtunes to ${VERSION}"
            git push
          else
            echo "No changes to commit."
          fi
